import React, { useState, useEffect } from 'react';
import '../Styles/Pocetna.css';
import obicnaprofilna from '../Slike/obicnaprofilna.png';
import { useNavigate } from "react-router-dom";
import { useAuth } from "../Login/AuthContext";
import axios from "axios";
import TopLista from './TopLista';
import Friends from '../Profil/Friends';

const Pocetna = () => {
  const navigate = useNavigate();
  const { user, logout } = useAuth();
  const [tokeni, setTokeni] = useState(0);
  const [isMobileLandscape, setIsMobileLandscape] = useState(false);

  useEffect(() => {
    const fetchTokeni = async () => {
      try {
        const response = await axios.post('http://localhost:5000/api/tokeni/daily', { 
          userId: user.id 
        });
        setTokeni(response.data.tokeni);
      } catch (error) {
        console.error('Greška prilikom ucitavanja tokena:', error);
      }
    };
    
    if (user?.id) fetchTokeni();
  }, [user]);

  useEffect(() => {
    const checkViewport = () => {
      const matches = window.matchMedia('(max-width: 1000px) and (orientation: landscape)').matches;
      setIsMobileLandscape(matches);
    };
  
    // Proveri odmah pri učitavanju
    checkViewport();
    
    // Postavi listener za promene
    window.addEventListener('resize', checkViewport);
    return () => window.removeEventListener('resize', checkViewport);
  }, []);

  const igrajHandler = async () => {
    if (!user?.id) {
      console.error('Korisnik nije prijavljen!');
      return;
    }
  
    // Pronađi odabrani sto
    const selectedTable = tables.find(table => table.id === activeTableId);
    if (!selectedTable) {
      alert('Niste odabrali sto!');
      return;
    }
  
    const requiredTokens = selectedTable.coins;
  
    try {
      // Provera stanja tokena
      const tokenResponse = await axios.get(`http://localhost:5000/api/tokeni/moji?userId=${user.id}`);
      if (tokenResponse.data.tokeni < requiredTokens) {
        alert(`Potrebno vam je ${requiredTokens} tokena za ovaj sto!`);
        return;
      }
  
      // Oduzimanje tokena
      await axios.post('http://localhost:5000/api/tokeni/dodaj', {
        userId: user.id,
        kolicina: -requiredTokens
      });
  
      // Osveži prikaz tokena
      const newTokenResponse = await axios.get(`http://localhost:5000/api/tokeni/moji?userId=${user.id}`);
      setTokeni(newTokenResponse.data.tokeni);
  
      // Kreiraj igru sa dodatnim parametrima
      const gameResponse = await axios.post('http://localhost:5000/api/games', { 
        userId: user.id,
        tableType: selectedTable.type,
        betAmount: requiredTokens
      });
      
      navigate(`/game/${gameResponse.data.gameId}`);
      
    } catch (error) {
      console.error('Greška:', error.response?.data || error.message);
      if (error.response?.data?.message) {
        alert(error.response.data.message);
      }
    }
  };

  const logoutHandler = () => {
    logout();
    navigate("/login");
  };

  const pravilaHandler = () => {
    navigate("/pravila");
  };

  const profilHandler = () => {
    navigate("/profil");
  };

  const kontaktHandler = () => {
    navigate("/kontakt");
  }
  
  const topListaHandler = () => {
    navigate("/top-liste");
  }

  const tables = [
    { id: 1, type: 'Privatna partija', coins: 100 },
    { id: 2, type: 'Pocetnici', coins: 200 },
    { id: 3, type: 'Prosecni', coins: 500 },
    { id: 4, type: 'Napredni', coins: 1000 }
  ];

  const [startIndex, setStartIndex] = useState(0);
  const [rotateAnim, setRotateAnim] = useState(false);
  const [isDropdownOpen, setIsDropdownOpen] = useState(false);

  const visibleTables = Array.from({ length: 3 }, (_, i) => {
    const index = (startIndex + i) % tables.length;
    return tables[index];
  });

  const activeTableId = visibleTables[1]?.id;


  const handleArrowClick = (direction) => {
    const newStartIndex = direction === 'left' 
      ? (startIndex - 1 + tables.length) % tables.length
      : (startIndex + 1) % tables.length;
    
    setRotateAnim(true);
    setTimeout(() => setRotateAnim(false), 500);
    setStartIndex(newStartIndex);
  };

  return (
    <div className="home-container">
      
      <div className="profile-section">
        {/* Ime i prezime korisnika */}
        <div className="user-info">
          <span className="user-name">{user?.ime} {user?.prezime}</span>
        </div>
        
        <div 
          className="profile-btn"
          onClick={() => setIsDropdownOpen(!isDropdownOpen)}
        >
          <img src={user?.profilna || obicnaprofilna} alt="Profilna Slika" />
        </div>
        {isDropdownOpen && (
          <div className="dropdown-menu">
            <div className="dropdown-item" onClick={profilHandler}>Moj Profil</div>
            <div className="dropdown-item">Nastavi partiju</div>
            <div className="dropdown-item" onClick={logoutHandler}>Odjavi se</div>
          </div>
        )}
        <div className="token-display">
          Tokeni: {tokeni}
        </div>

        <div className="friends-buttons">
          <Friends />
        </div>
      </div>
      <div className="main-content">
      {!isMobileLandscape && <TopLista />}
        <div className="game-tables-container">
        <h1 className='meksikoheader'>MEKSIKO</h1>
          <div className="table-carousel">
            <button 
              className="arrow left-arrow" 
              onClick={() => handleArrowClick('left')}
            >
              ←
            </button>
            
            <div className={`table-container3 ${rotateAnim ? 'rotate' : ''}`}>
              {visibleTables.map((table, index) => (
                <div
                  key={table.id}
                  className={`game-table ${activeTableId === table.id ? 'active' : ''}`}
                >
                  <div className="table-header">
                    <span>{table.type}</span>
                  </div>
                  <div className="table-body">
                    {table.coins > 0 && <span className="coin-cost">{table.coins}</span>} tokena
                  </div>
                </div>
              ))}
            </div>

            <button 
              className="arrow right-arrow" 
              onClick={() => handleArrowClick('right')}
            >
              →
            </button>
          </div>
          {/* Dugme IGRAJ se pozicionira ispod centra */}
          <div className="play-btn-container">
            <button className="igraj-btn" onClick={igrajHandler}>IGRAJ</button>
          </div>
        </div>

        <div className="action-buttons">
          <button className="btn rules-btn" onClick={pravilaHandler}>‎ ‎ ‎ ‎ Pravila ‎ ‎ ‎  ‎ </button>
          <button className="btn rules-btn" onClick={kontaktHandler}>‎ ‎ ‎ Kontakt ‎ ‎ ‎</button>
          <button className="btn settings-btn">Kupi Tokene</button>
          <button className="btn settings-btn" onClick={() => navigate('/gledaj-video')}>Gledaj Video</button>
          {isMobileLandscape && <button className="btn settings-btn" onClick={topListaHandler}>Top Liste</button>}
        </div>
      </div>
    </div>
  );
};

export default Pocetna;
